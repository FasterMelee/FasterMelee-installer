#!/bin/sh

set -e

ORIGINALPATH="$PWD"
COMMITHASH="dd88b80e231f79e2f257dfe793adfe5a4431ec8d"
REPLACEFILENAME="FM_reqFiles.tar.gz"
REPLACEFILELINK="https://github.com/Ptomerty/FasterMelee-installer/raw/master/$REPLACEFILENAME"
GITCLONELINK="https://github.com/HannesMann/Ishiiruka"
FMVERSION="5.5" #5.5 by default
DAY=$(date +%D)
FOLDERNAME="FasterMelee-$FMVERSION-$DAY"
LOG="$ORIGINALPATH/$FOLDERNAME/log.txt"

# Source: https://gist.github.com/jj1bdx/5746298
# `` kept in for legacy support, could replace with $(...)

# Linux and similar...
CPUS=$(getconf _NPROCESSORS_ONLN 2>/dev/null)
# FreeBSD and similar...
[ -z "$CPUS" ] && CPUS=$(getconf NPROCESSORS_ONLN)
# Solaris and similar...
[ -z "$CPUS" ] && CPUS=$(ksh93 -c 'getconf NPROCESSORS_ONLN')
# Give up...
[ -z "$CPUS" ] && CPUS=1

install() {
	echo "Downloading required replacement files..."
	wget $REPLACEFILELINK
	echo "Extracting..."
	tar -xzf $REPLACEFILENAME
	rm $REPLACEFILENAME

	echo "Adding adapter support (requires sudo permissions)..."
	sudo rm /etc/udev/rules.d/51-gcadapter.rules 2> /dev/null # remove even if doesn't exist
	# sudo touch /etc/udev/rules.d/51-gcadapter.rules
	echo 'SUBSYSTEM=="usb", ENV{DEVTYPE}=="usb_device", ATTRS{idVendor}=="057e", ATTRS{idProduct}=="0337", MODE="0666"' | sudo tee /etc/udev/rules.d/51-gcadapter.rules > /dev/null # pipe to write-protected file, remove STDOUT
	sudo udevadm control --reload-rules
	echo "Rules added!" # set -e will take care of if/else

	echo "Cloning repo (may take a while)..."
	git clone $GITCLONELINK
	cd Ishiiruka
	echo "Switching to latest commit..."
	git checkout $COMMITHASH >>"$LOG" 2>&1

	echo "Adding portable files..."
	mkdir build && cd build
	mv ../../Binaries .

	echo "cmaking..."
	cmake .. -DLINUX_LOCAL_DEV=true >>"$LOG" 2>&1

	echo "Compiling...(Verbose, will take a while)"
	make -j$CPUS 2>>"$LOG" # gets rid of errors as to not cause confusion

	echo "Cleaning up..."
	rm "$ORIGINALPATH/FasterMelee/log.txt"
	cd ../..
	mv Ishiiruka/build/Binaries/ bin/
	rm -rf Ishiiruka # -f required to remove git files
	ln -s FasterMelee/bin/dolphin-emu ../launch-fm

	echo 'Done! Run ./launch-fm to run!'
	echo 'Make sure to unplug and replug your adapter before opening Dolphin for it to function!'
}

echo "tail -f $LOG to follow along with the log, or for troubleshooting!"

echo "Would you like to overwrite your previous installations? (y/N)"
read -r RESP

if [ ! "$RESP" = "y" ]; then
	rm -r FasterMelee*/ launch-faster-melee launch-fm
fi

echo "CPU Threads detected: $CPUS"
echo "How many threads would you like to use to compile? (passed to make as -j flag, default: 1, max: $((CPUS + 1)))"
read -r RESP

if [ "$RESP" -ge 1 ] && [ "$RESP" -le $((CPUS + 1)) ] 2> /dev/null; then
	CPUS=$RESP #checks 
else
	CPUS=1
fi

mkdir "$FOLDERNAME" && cd "$FOLDERNAME"

install

